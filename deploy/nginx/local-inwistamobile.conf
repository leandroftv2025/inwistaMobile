# ====================================
# INWISTAMOBILE - NGINX CONFIGURATION
# ====================================
# Reverse proxy com HTTP + HTTPS local (mkcert)
# Serve inwistaMobile no caminho /mobile ou subdomínio

# ----------------------------------------
# UPSTREAM (Backend Express na porta 5000)
# ----------------------------------------
upstream inwistamobile_backend {
    server 127.0.0.1:5000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# ----------------------------------------
# HTTP SERVER (Porta 80) - Redirect para HTTPS
# ----------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name mobile.192.168.1.15.nip.io 192.168.1.15;

    # Log files
    access_log /var/log/nginx/inwistamobile-http-access.log;
    error_log /var/log/nginx/inwistamobile-http-error.log warn;

    # Redirect permanente para HTTPS
    location / {
        return 301 https://$host$request_uri;
    }

    # Health check sem redirect (para load balancers)
    location /healthz {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# ----------------------------------------
# HTTPS SERVER (Porta 443) - TLS Local (mkcert)
# ----------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mobile.192.168.1.15.nip.io 192.168.1.15;

    # ========================================
    # SSL/TLS CONFIGURATION (mkcert)
    # ========================================
    # Gere os certificados com:
    #   mkcert -install
    #   mkcert mobile.192.168.1.15.nip.io 192.168.1.15 localhost
    #
    # IMPORTANTE: Ajuste os caminhos abaixo para onde você salvou os certificados
    ssl_certificate /etc/nginx/ssl/mobile.192.168.1.15.nip.io.pem;
    ssl_certificate_key /etc/nginx/ssl/mobile.192.168.1.15.nip.io-key.pem;

    # Protocolos e ciphers modernos
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    # SSL session cache
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # OCSP Stapling (desabilitado para certs locais)
    # ssl_stapling on;
    # ssl_stapling_verify on;

    # ========================================
    # SECURITY HEADERS
    # ========================================
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ========================================
    # LOG FILES
    # ========================================
    access_log /var/log/nginx/inwistamobile-https-access.log;
    error_log /var/log/nginx/inwistamobile-https-error.log warn;

    # ========================================
    # GZIP COMPRESSION
    # ========================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/x-javascript image/svg+xml;
    gzip_min_length 1024;

    # ========================================
    # CLIENT LIMITS
    # ========================================
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 16k;

    # ========================================
    # TIMEOUTS
    # ========================================
    client_body_timeout 60s;
    client_header_timeout 60s;
    keepalive_timeout 65s;
    send_timeout 60s;

    # ========================================
    # PROXY SETTINGS (PADRÃO)
    # ========================================
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Timeouts de proxy
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # ========================================
    # LOCATION: BACKEND API (inwistaMobile)
    # ========================================
    location / {
        proxy_pass http://inwistamobile_backend;

        # Headers específicos para API
        proxy_set_header X-Request-Start "t=${msec}";

        # Desabilitar cache para API
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
        add_header Pragma "no-cache" always;
        expires off;
    }

    # ========================================
    # LOCATION: WEBSOCKET (se necessário)
    # ========================================
    location /ws {
        proxy_pass http://inwistamobile_backend;

        # WebSocket específico
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;

        # Timeouts aumentados para WS
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # ========================================
    # LOCATION: HEALTH CHECKS
    # ========================================
    location /healthz {
        proxy_pass http://inwistamobile_backend/api/healthz;
        access_log off;
    }

    location /api/health {
        proxy_pass http://inwistamobile_backend/api/health;
        access_log off;
    }

    location /api/ready {
        proxy_pass http://inwistamobile_backend/api/ready;
        access_log off;
    }

    # ========================================
    # LOCATION: STATIC ASSETS (se servir frontend)
    # ========================================
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
        proxy_pass http://inwistamobile_backend;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}

# ========================================
# CONFIGURAÇÃO ALTERNATIVA: SUBCAMINHO /mobile
# ========================================
# Se quiser servir em https://192.168.1.15/mobile em vez de subdomínio,
# adicione esta configuração ao server block principal (inwistasite):
#
# location /mobile/ {
#     rewrite ^/mobile/(.*) /$1 break;
#     proxy_pass http://inwistamobile_backend;
#
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "upgrade";
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_set_header X-Forwarded-Prefix /mobile;
# }
#
# location /mobile/api/ {
#     rewrite ^/mobile/(.*) /$1 break;
#     proxy_pass http://inwistamobile_backend;
#
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
# }

# ========================================
# INSTRUÇÕES DE INSTALAÇÃO
# ========================================
# 1. Gerar certificados locais com mkcert:
#    sudo apt install mkcert
#    mkcert -install
#    mkcert mobile.192.168.1.15.nip.io 192.168.1.15 localhost
#    sudo mv mobile.192.168.1.15.nip.io*.pem /etc/nginx/ssl/
#
# 2. Copiar este arquivo:
#    sudo cp local-inwistamobile.conf /etc/nginx/sites-available/
#    sudo ln -s /etc/nginx/sites-available/local-inwistamobile.conf /etc/nginx/sites-enabled/
#
# 3. Testar configuração:
#    sudo nginx -t
#
# 4. Recarregar Nginx:
#    sudo systemctl reload nginx
#
# 5. Testar:
#    curl -k https://mobile.192.168.1.15.nip.io/api/health
#    curl -k https://192.168.1.15/mobile/api/health  (se usar subcaminho)
