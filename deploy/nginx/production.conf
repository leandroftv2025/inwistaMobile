# ====================================
# INWISTA - NGINX PRODUCTION CONFIG
# ====================================
# Configuração otimizada para produção
# Domínios: www.inwista.com, app.inwista.com

# Cache para assets estáticos
proxy_cache_path /var/cache/nginx/inwista levels=1:2 keys_zone=inwista_cache:10m max_size=500m inactive=60m use_temp_path=off;

# Rate limiting
limit_req_zone $binary_remote_addr zone=inwista_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Upstream para inwistasite
upstream inwistasite {
    server localhost:8080;
    keepalive 32;
}

# Upstream para inwistaMobile
upstream inwistamobile {
    server localhost:5000;
    keepalive 32;
}

# ========================================
# INWISTASITE - www.inwista.com
# ========================================

# Redirect inwista.com → www.inwista.com
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name inwista.com;

    # SSL configurado pelo Certbot
    ssl_certificate /etc/letsencrypt/live/inwista.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/inwista.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://www.inwista.com$request_uri;
}

# Main site - www.inwista.com
server {
    listen 80;
    listen [::]:80;
    server_name www.inwista.com;

    # Redirect HTTP → HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.inwista.com;

    # SSL configurado pelo Certbot
    ssl_certificate /etc/letsencrypt/live/inwista.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/inwista.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Logs
    access_log /var/log/inwista/inwistasite_access.log combined buffer=32k flush=5s;
    error_log /var/log/inwista/inwistasite_error.log warn;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        application/atom+xml
        image/svg+xml;

    # Rate limiting
    limit_req zone=inwista_limit burst=20 nodelay;
    limit_conn addr 10;

    # Health check
    location /healthz {
        proxy_pass http://inwistasite/healthz;
        access_log off;
    }

    # Proxy para container inwistasite
    location / {
        proxy_pass http://inwistasite;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Cache
        proxy_cache inwista_cache;
        proxy_cache_valid 200 10m;
        proxy_cache_valid 404 1m;
        proxy_cache_bypass $http_cache_control;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Cache para assets estáticos
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        proxy_pass http://inwistasite;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # Cache agressivo
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status $upstream_cache_status;

        # Cache no proxy
        proxy_cache inwista_cache;
        proxy_cache_valid 200 365d;
        proxy_ignore_headers Cache-Control;
    }
}

# ========================================
# INWISTAMOBILE - app.inwista.com
# ========================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name app.inwista.com;

    return 301 https://$server_name$request_uri;
}

# Main app
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.inwista.com;

    # SSL configurado pelo Certbot
    ssl_certificate /etc/letsencrypt/live/app.inwista.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.inwista.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Logs
    access_log /var/log/inwista/inwistamobile_access.log combined buffer=32k flush=5s;
    error_log /var/log/inwista/inwistamobile_error.log warn;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Aumentar tamanho de upload
    client_max_body_size 10M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss;

    # Rate limiting (mais permissivo para API)
    limit_req zone=inwista_limit burst=50 nodelay;
    limit_conn addr 20;

    # Health check
    location /api/healthz {
        proxy_pass http://inwistamobile/api/healthz;
        access_log off;
    }

    # API endpoints - sem cache
    location /api/ {
        proxy_pass http://inwistamobile;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts maiores para API
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;

        # Sem cache para API
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }

    # Frontend - com cache
    location / {
        proxy_pass http://inwistamobile;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Cache leve
        proxy_cache inwista_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_bypass $http_cache_control;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Cache para assets estáticos
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        proxy_pass http://inwistamobile;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # Cache agressivo
        expires 1y;
        add_header Cache-Control "public, immutable";

        # Cache no proxy
        proxy_cache inwista_cache;
        proxy_cache_valid 200 365d;
    }
}
